############################################################################################
#                                                                                          #
# This script add every *required* ResourceGroup tags into each resource contained in it.  #
# It does not ovverride existing tags.                                                     #
#                                                                                          #
############################################################################################

$connectionName = "AzureRunAsConnection"
try
{
    $servicePrincipalConnection=Get-AutomationConnection -Name $connectionName         
    Add-AzureRmAccount `
        -ServicePrincipal `
        -TenantId $servicePrincipalConnection.TenantId `
        -ApplicationId $servicePrincipalConnection.ApplicationId `
        -CertificateThumbprint $servicePrincipalConnection.CertificateThumbprint 
}
catch {
    if (!$servicePrincipalConnection)
    {
        $ErrorMessage = "Connection $connectionName not found."
        throw $ErrorMessage
    } else{
        Write-Error -Message $_.Exception
        throw $_.Exception
    }
}

$requiredTags = @("bl", "env", "owner", "region", "svc")

$resGroups = Get-AzureRmResourceGroup
foreach ($resGroup in $resGroups) {
    if ($resGroup.Tags -ne $null) {
		$resources = $resGroup | Find-AzureRmResource
		foreach ($resource in $resources)
		{
            $resourcetagsource = (Get-AzureRmResource -ResourceId $resource.ResourceId).Tags
            if ($resourcetagsource -eq $null) {
                $resourcetagsource =  @()
            }
            $resourcetags = $resourcetagsource
            foreach ($tag in $resGroup.Tags)
            {
                if ($requiredTags.contains($tag.Name)) {$resourcetags += $tag }
            }
            
            # Append existing tags to the "resourcetags" variable -- in this way no existing tags are overwritten
            $resourcetags += $resourcetagsource

			Set-AzureRmResource -Tag $resourcetags -ResourceId $resource.ResourceId -Force
		}
	}
}
